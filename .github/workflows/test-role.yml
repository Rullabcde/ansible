name: Molecule Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  molecule-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install molecule[docker] ansible-lint yamllint
          pip install molecule-plugins[docker]
          pip install testinfra
          pip install pytest

      - name: Find Ansible roles
        id: find-roles
        run: |
          ROLES_DIR="ansible-molecule/server/roles"

          if [ -d "$ROLES_DIR" ]; then
            ROLES=$(find $ROLES_DIR -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n")[:-1]')
            echo "roles=$ROLES" >> $GITHUB_OUTPUT
            echo "Found roles: $ROLES"
            echo "Roles directory found: $ROLES_DIR"
          else
            echo "roles=[]" >> $GITHUB_OUTPUT
            echo "No roles directory found at: $ROLES_DIR"
          fi

      - name: Test each role with Molecule
        if: steps.find-roles.outputs.roles != '[]'
        run: |
          ROLES_DIR="ansible-molecule/server/roles"

          echo "${{ steps.find-roles.outputs.roles }}" | jq -r '.[]' | while read role; do
            echo "Testing role: $role"
            
            cd "$ROLES_DIR/$role"
            
            if [ -f "molecule/default/molecule.yml" ] || [ -f "molecule.yml" ]; then
              echo "Running molecule test for $role..."
              
              export TESTINFRA_BACKEND=ansible
              
              molecule test
              
              if [ $? -eq 0 ]; then
                echo "✅ Molecule test passed for role: $role"
              else
                echo "❌ Molecule test failed for role: $role"
                exit 1
              fi
            else
              echo "⚠️  No molecule configuration found for role: $role, skipping..."
            fi
            
            cd - > /dev/null
          done

      - name: Summary
        if: always()
        run: |
          echo "Molecule testing completed for all roles in the specified directory"
