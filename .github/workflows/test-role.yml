name: Test All Ansible Roles

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  ANSIBLE_FORCE_COLOR: "1"
  PY_COLORS: "1"

jobs:
  test_roles:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: 3. Install dependencies
        run: |
          pip install --upgrade pip wheel
          pip install -r requirements.txt

      - name: 4. Run YAML Lint
        working-directory: ansible-molecule/server/roles
        run: |
          echo "::group::🔍 Running YAML Lint"
          for role_dir in */; do
            if [ -d "$role_dir" ]; then
              echo "Linting YAML files in role: $(basename "$role_dir")"
              find "$role_dir" -name "*.yml" -o -name "*.yaml" | xargs yamllint -c .yamllint || true
            fi
          done
          echo "::endgroup::"

      - name: 5. Run Ansible Lint
        working-directory: ansible-molecule/server/roles
        run: |
          for role_dir in */; do
            if [ -d "$role_dir" ]; then
              echo "::group::🔍 Linting role: $(basename "$role_dir")"
              ansible-lint "$role_dir" --force-color || echo "⚠️ Lint issues found in $role_dir"
              echo "::endgroup::"
            fi
          done
          echo "✅ Ansible Lint completed for all roles!"

      - name: 6. Run Molecule tests for all roles
        working-directory: ansible-molecule/server/roles
        run: |
          for role_dir in */; do
            if [ -d "$role_dir/molecule" ]; then
              echo "::group::🧪 Testing role: $(basename "$role_dir")"
              cd "$role_dir"
              molecule test --scenario-name default || {
                echo "❌ Test failed for role: $(basename "$role_dir")"
                exit 1
              }
              cd ..
              echo "::endgroup::"
            else
              echo "⚠️ No molecule tests found for role: $(basename "$role_dir")"
            fi
          done
          echo "✅ All Ansible roles passed Molecule tests successfully!"

      - name: 7. Test Summary
        if: always()
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ YAML Lint: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Ansible Lint: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Molecule Tests: Completed" >> $GITHUB_STEP_SUMMARY
