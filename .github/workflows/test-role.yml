name: Test All Ansible Roles

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  yaml_lint:
    name: YAML Lint Check
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: 3. Install yamllint
        run: |
          pip install --upgrade pip
          pip install yamllint

      - name: 4. Run yamllint with custom config
        run: |
          echo "üîç Running yamllint with custom config..."
          yamllint -c .yamllint . || {
            echo "‚ùå yamllint check failed!"
            exit 1
          }
          echo "‚úÖ All YAML files passed yamllint check!"

  test_roles:
    name: Molecule Tests
    runs-on: ubuntu-latest
    needs: yaml_lint

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: 3. Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: 4. Run Molecule tests for all roles
        working-directory: ansible-molecule/server/roles
        run: |
          for role_dir in */; do
            if [ -d "$role_dir/molecule" ]; then
              echo "::group::üß™ Testing role: $(basename "$role_dir")"
              cd "$role_dir"
              molecule test --scenario-name default || {
                echo "‚ùå Test failed for role: $(basename "$role_dir")"
                exit 1
              }
              cd ..
              echo "::endgroup::"
            else
              echo "‚ö†Ô∏è No molecule tests found for role: $(basename "$role_dir")"
            fi
          done
          echo "‚úÖ All Ansible roles passed Molecule tests successfully!"
